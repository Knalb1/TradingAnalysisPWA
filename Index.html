<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HTML NEXUS V5 ‚Äì Progressive Web App</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1db954">
<link rel="icon" href="icons/icon-192.png">
<style>
:root {
  --bg:#0c0f14;--bg2:#171b22;--accent:#1db954;
  --text:#e2e2e2;--muted:#999;--danger:#e74c3c;
  --font:'Segoe UI',Roboto,sans-serif;
}
body{background:var(--bg);color:var(--text);font-family:var(--font);margin:0}
header{
  background:var(--bg2);display:flex;justify-content:space-between;align-items:center;
  padding:1rem 2rem;border-bottom:1px solid #222
}
h1{margin:0;color:var(--accent);font-size:1.4rem}
button,input[type=file]{
  background:var(--accent);color:#fff;border:none;border-radius:4px;
  padding:.5rem 1rem;font-weight:600;cursor:pointer
}
button:hover{opacity:.9}
main{padding:1rem 2rem 4rem;display:flex;flex-direction:column;gap:2rem}
section{
  background:var(--bg2);border-radius:8px;padding:1rem 1.5rem 1.5rem;
  box-shadow:0 2px 8px rgba(0,0,0,0.3)
}
h2{color:var(--accent);border-bottom:1px solid #222;padding-bottom:.3rem}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
.metric-box{background:#11151b;border-left:4px solid var(--accent);padding:1rem;border-radius:4px}
.metric-value{font-size:1.4rem;font-weight:bold;color:var(--accent)}
#dropZone{border:2px dashed var(--accent);border-radius:8px;padding:2rem;text-align:center;color:var(--muted)}
#dropZone.dragover{background:rgba(29,185,84,0.1)}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{padding:.4rem .6rem;border-bottom:1px solid #222}
th{color:var(--accent);text-align:left}
tr:hover{background:rgba(255,255,255,.05)}
select{background:var(--bg2);color:var(--text);border:1px solid #333;padding:.4rem .6rem;border-radius:4px}
canvas{width:100%!important;height:350px!important}
footer{text-align:center;color:var(--muted);padding:2rem;font-size:.8rem}
.fade-in{animation:fade .6s ease-out}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<header>
  <h1>HTML NEXUS V5 ‚ö°</h1>
  <div>
    <label><input type="file" id="fileInput" multiple hidden><button>Select Files</button></label>
    <button id="saveAccountBtn">üíæ Save Account</button>
    <select id="accountSelect"><option value="">Select Account</option></select>
  </div>
</header>

<main>
  <section id="dropZone"><h2>Drop your NEXUS files here</h2><p>or click ‚ÄúSelect Files‚Äù</p></section>
  <section><h2>Account Summary</h2><div class="grid" id="metricGrid"></div></section>
  <section><h2>Equity Curve</h2><canvas id="equityChart"></canvas></section>
  <section><h2>Monthly Returns</h2><canvas id="heatmapChart"></canvas></section>
  <section><h2>Trade Distribution</h2><canvas id="histChart"></canvas></section>
  <section><h2>Execution Quality</h2><canvas id="slippageChart"></canvas><canvas id="latencyChart"></canvas></section>
  <section><h2>Trades</h2>
    <table id="tradesTable"><thead><tr><th>Ticket</th><th>Symbol</th><th>Open</th><th>Close</th><th>Vol</th><th>PnL</th><th>%</th><th>Duration</th></tr></thead><tbody></tbody></table>
  </section>
</main>
<footer>HTML NEXUS V5 ‚Äì Progressive Analytics Suite ¬©2025</footer>

<script>
const fileInput=document.getElementById('fileInput');
const dropZone=document.getElementById('dropZone');
const select=document.getElementById('accountSelect');
const saveBtn=document.getElementById('saveAccountBtn');
const fmt=n=>Number.parseFloat(n).toFixed(2),fmtPct=n=>(n*100).toFixed(2)+'%';
let trades=[],execs=[],equityCurve=[],metrics={};

['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault();dropZone.classList.add('dragover')}));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault();dropZone.classList.remove('dragover')}));
dropZone.addEventListener('drop',e=>parseFiles([...e.dataTransfer.files]));
fileInput.addEventListener('change',e=>parseFiles([...e.target.files]));

async function parseFiles(files){
  trades=[];execs=[];
  document.getElementById('metricGrid').innerHTML='Parsing ‚è≥...';
  for(const f of files){
    if(f.name.endsWith('.csv')){
      const res=await new Promise(r=>Papa.parse(f,{header:true,skipEmptyLines:true,complete:r}));
      if(f.name.includes('trades')) trades=trades.concat(res.data);
      if(f.name.includes('execution')) execs=execs.concat(res.data);
    } else if(f.name.endsWith('.json')){
      metrics.meta=JSON.parse(await f.text());
    }
  }
  computeMetrics();
}
function std(a){const m=a.reduce((x,y)=>x+y,0)/a.length;return Math.sqrt(a.map(v=>(v-m)**2).reduce((x,y)=>x+y,0)/a.length);}
function avg(a){return a.length?a.reduce((x,y)=>x+y,0)/a.length:0;}
function computeMetrics(){
  if(!trades.length){alert('No trades found');return;}
  trades.sort((a,b)=>new Date(a.close_time_iso||a.close_time)-new Date(b.close_time_iso||b.close_time));
  let bal=0,maxBal=0,dd=0;
  equityCurve=trades.map(t=>{
    const p=parseFloat(t.profit||0);bal+=p;maxBal=Math.max(maxBal,bal);dd=Math.min(dd,bal-maxBal);
    return {t:new Date(t.close_time_iso||t.close_time),bal};
  });
  const total=bal,maxDD=Math.abs(dd);
  const avgTrade=bal/trades.length,winRate=trades.filter(t=>t.profit>0).length/trades.length;
  const sharpe=(avgTrade/std(trades.map(t=>parseFloat(t.profit||0))))*Math.sqrt(252);
  metrics={...metrics,total,maxDD,avgTrade,winRate,sharpe,n:trades.length};
  renderAll();
}

function renderAll(){
  renderSummary();renderCharts();renderTable();storeTempAccount();
}
function renderSummary(){
  const g=document.getElementById('metricGrid');g.innerHTML='';
  [['Total Profit',fmt(metrics.total)],['Max DD',fmt(metrics.maxDD)],['Avg/Trade',fmt(metrics.avgTrade)],['Win Rate',fmtPct(metrics.winRate)],['Sharpe',fmt(metrics.sharpe)],['Trades',metrics.n]]
  .forEach(([k,v])=>{
    const d=document.createElement('div');d.className='metric-box fade-in';d.innerHTML=`<div>${k}</div><div class="metric-value">${v}</div>`;g.appendChild(d);
  });
}
function renderCharts(){
  const eq=document.getElementById('equityChart').getContext('2d');
  new Chart(eq,{type:'line',data:{labels:equityCurve.map(e=>e.t),datasets:[{label:'Equity',data:equityCurve.map(e=>e.bal),borderColor:'#1db954',fill:false}]},
  options:{scales:{x:{type:'time',time:{unit:'day'},ticks:{color:'#ccc'}},y:{ticks:{color:'#ccc'}}}}});
  // Histogram
  const profits=trades.map(t=>parseFloat(t.profit||0));const bins=20;
  const min=Math.min(...profits),max=Math.max(...profits),step=(max-min)/bins,h=Array(bins).fill(0);
  profits.forEach(p=>{const i=Math.min(bins-1,Math.floor((p-min)/step));h[i]++;});
  new Chart(document.getElementById('histChart').getContext('2d'),{type:'bar',data:{labels:Array.from({length:bins},(_,i)=>fmt(min+i*step)),datasets:[{label:'Count',data:h,backgroundColor:'#1db954'}]},options:{scales:{x:{ticks:{color:'#ccc'}},y:{ticks:{color:'#ccc'}}}}});
  // Monthly
  const monthly={};
  trades.forEach(t=>{const d=new Date(t.close_time_iso||t.close_time);const k=d.getFullYear()+'-'+(d.getMonth()+1);monthly[k]=(monthly[k]||0)+parseFloat(t.profit||0);});
  const keys=Object.keys(monthly).sort();
  new Chart(document.getElementById('heatmapChart').getContext('2d'),{type:'bar',data:{labels:keys,datasets:[{label:'Monthly Profit',data:keys.map(k=>monthly[k]),backgroundColor:'#1db954'}]},options:{scales:{x:{ticks:{color:'#ccc'}},y:{ticks:{color:'#ccc'}}}}});
  if(execs.length){
    const slip=execs.map(e=>parseFloat(e.slippage_points||0)),lat=execs.map(e=>parseFloat(e.exec_time_ms||0));
    new Chart(document.getElementById('slippageChart').getContext('2d'),{type:'bar',data:{labels:['Avg','Max'],datasets:[{label:'Slippage pts',data:[avg(slip),Math.max(...slip)],backgroundColor:'#e74c3c'}]},options:{scales:{y:{ticks:{color:'#ccc'}}}}});
    new Chart(document.getElementById('latencyChart').getContext('2d'),{type:'bar',data:{labels:['Avg','Max'],datasets:[{label:'Latency ms',data:[avg(lat),Math.max(...lat)],backgroundColor:'#f39c12'}]},options:{scales:{y:{ticks:{color:'#ccc'}}}}});
  }
}
function renderTable(){
  const tb=document.querySelector('#tradesTable tbody');tb.innerHTML='';
  trades.slice(-500).reverse().forEach(t=>{
    const open=new Date(t.open_time_iso||t.open_time),close=new Date(t.close_time_iso||t.close_time);
    const dur=(close-open)/60000;const ret=parseFloat(t.profit||0)/Math.max(1,parseFloat(t.open_price||1)*parseFloat(t.volume||1));
    const row=document.createElement('tr');
    row.innerHTML=`<td>${t.ticket}</td><td>${t.symbol}</td><td>${open.toISOString().slice(0,16).replace('T',' ')}</td><td>${close.toISOString().slice(0,16).replace('T',' ')}</td><td>${fmt(t.volume)}</td><td style="color:${t.profit>=0?'#1db954':'#e74c3c'}">${fmt(t.profit)}</td><td>${fmtPct(ret)}</td><td>${fmt(dur)}</td>`;
    tb.appendChild(row);
  });
}

// ------------------  ACCOUNT MANAGEMENT (IndexedDB) ------------------
let db;
initDB();
async function initDB(){
  const req=indexedDB.open('NEXUS_DB',1);
  req.onupgradeneeded=e=>{
    const db=e.target.result;
    db.createObjectStore('accounts',{keyPath:'name'});
  };
  req.onsuccess=e=>{
    db=e.target.result;
    loadAccounts();
  };
}
function loadAccounts(){
  const tx=db.transaction('accounts','readonly');
  const store=tx.objectStore('accounts');
  const req=store.getAll();
  req.onsuccess=e=>{
    select.innerHTML='<option value="">Select Account</option>';
    e.target.result.forEach(a=>{
      const opt=document.createElement('option');
      opt.value=a.name;opt.textContent=a.name;select.appendChild(opt);
    });
  };
}
function storeTempAccount(){
  window.currentTemp={trades,execs,metrics};
}
saveBtn.onclick=function(){
  if(!db||!window.currentTemp){alert('No account data loaded');return;}
  const name=prompt('Account name to save?');if(!name)return;
  const tx=db.transaction('accounts','readwrite');
  tx.objectStore('accounts').put({name,...window.currentTemp});
  tx.oncomplete=()=>{alert('Saved!');loadAccounts();};
};
select.onchange=function(){
  const name=this.value;if(!name)return;
  const tx=db.transaction('accounts','readonly');
  tx.objectStore('accounts').get(name).onsuccess=e=>{
    const acc=e.target.result;
    if(!acc)return;
    trades=acc.trades;execs=acc.execs;metrics=acc.metrics;
    renderAll();
  };
};

// ------------------  SERVICE WORKER REGISTRATION ------------------
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('worker.js').then(()=>console.log('SW registered'));
}
</script>
</body>
</html>